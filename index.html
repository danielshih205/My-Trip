<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- V5.1 ç©¶æ¥µé©é… Viewport: ç¦æ­¢ç¸®æ”¾, é©é…å…¨è¢å¹• -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¤¢å¹»æ—…éŠ">
    <title>DreamVoyage V5.1 | ç©¶æ¥µç§»å‹•é©é…ç‰ˆ</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-yellow: #fbce1e;
            --primary-dark: #020617;
            --accent-orange: #f59e0b;
            --bg-soft: #fffef2;
            --card-shadow: 0 15px 35px rgba(251, 206, 30, 0.12);
            --border-light: #f1f5f9;
            --nav-height: 75px;
            --footer-height: 80px;
            --teal-main: #0d9488;
            --teal-light: #ccfbf1;
            --dark-card-bg: #0f172a;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, 'Quicksand', 'Noto Sans TC', sans-serif;
            background: var(--bg-soft);
            margin: 0;
            color: var(--primary-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overscroll-behavior: none;
        }

        /* --- éŸ¿æ‡‰å¼å°è¦½åˆ— --- */
        nav {
            height: var(--nav-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--primary-yellow);
            padding-top: env(safe-area-inset-top);
        }

        .nav-steps { 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            padding: 5px 0;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .nav-steps::-webkit-scrollbar { display: none; }

        .step-btn {
            padding: 8px 18px;
            border: none;
            background: #f1f5f9;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            color: #64748b;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .step-btn.active {
            background: var(--primary-yellow);
            color: var(--primary-dark);
            box-shadow: 0 5px 12px rgba(251, 206, 30, 0.3);
        }

        .container {
            max-width: 1250px;
            margin: 0 auto;
            padding: 15px;
            flex: 1;
            width: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }

        .section { display: none; height: 100%; animation: fadeIn 0.4s ease; }
        .section.active { display: flex; flex-direction: column; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 15px;
            border: 1px solid rgba(251, 206, 30, 0.05);
        }

        input, select, textarea {
            padding: 10px 14px;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            font-size: 16px; /* é—œéµï¼šé˜²æ­¢ iOS ç¸®æ”¾ */
            outline: none;
            background: #fff;
            width: 100%;
            height: 46px;
            font-family: inherit;
        }

        /* --- Step 2 è¡Œç¨‹åˆ—æ‰‹æ©Ÿå„ªåŒ– --- */
        .item-row {
            display: grid;
            grid-template-columns: 120px 1fr 40px; /* é›»è…¦ç‰ˆä½ˆå±€ */
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
            background: #fff;
            padding: 15px;
            border-radius: 20px;
            border: 1px solid #f1f5f9;
        }

        @media (max-width: 768px) {
            .item-row {
                grid-template-columns: 1fr 1fr; /* æ‰‹æ©Ÿç‰ˆå †ç–Šä½ˆå±€ */
                gap: 8px;
            }
            .item-row > input[type="text"] { grid-column: 1 / -1; } /* åç¨±ä½”æ»¿ */
            .item-row > .note-cell { grid-column: 1 / -1; } /* å‚™è¨»ä½”æ»¿ */
            .item-row > .btn-del { justify-self: end; }
        }

        .note-cell textarea {
            height: 46px;
            min-height: 46px;
            max-height: 200px;
            resize: none;
            line-height: 1.6;
            background: #fcfcfc;
        }

        /* --- æ—¥æœŸåˆ‡æ›åˆ— --- */
        .day-nav-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            background: white;
            padding: 20px 10px 10px; 
            border-radius: 20px;
            border: 1px solid #f1f5f9;
        }

        .day-tabs-container {
            display: flex;
            gap: 10px;
            overflow-x: auto; 
            padding: 15px 5px 5px;
            flex: 1;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .day-tabs-container::-webkit-scrollbar { display: none; }

        .day-tab {
            padding: 10px 22px;
            background: #f8fafc;
            border-radius: 14px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 700;
            color: #64748b;
            font-size: 0.85rem;
            flex-shrink: 0;
            border: 2px solid transparent;
        }
        .day-tab.active { background: var(--primary-yellow); color: var(--primary-dark); }
        .day-tab.is-today { border-color: var(--accent-orange); }

        /* --- Step 3 æ˜Ÿç©ºæ‰‹æ©Ÿé©é… --- */
        #constellation-container {
            flex: 1;
            width: 100%;
            background: radial-gradient(circle at center, #0f172a 0%, #01040a 100%);
            border-radius: 35px;
            position: relative;
            overflow: hidden;
            min-height: 350px;
        }

        /* --- Step 4 æ‹†å¸³æ‰‹æ©Ÿå„ªåŒ– --- */
        .split-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 100%;
        }
        @media (max-width: 1024px) {
            .split-layout { grid-template-columns: 1fr; }
        }

        .members-compact-container {
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        .member-mini-pill {
            background: white; padding: 6px 12px; border-radius: 20px; border: 1px solid #e2e8f0;
            font-size: 0.85rem; font-weight: 700;
        }

        .settlement-card {
            background: var(--dark-card-bg);
            border-radius: 24px;
            padding: 20px;
            color: white;
            display: flex; flex-direction: column;
            min-height: 200px;
        }

        .split-item-card {
            background: white; border-radius: 20px; padding: 18px; margin-bottom: 12px;
            border: 1px solid #f1f5f9;
        }
        
        .split-unified-bar {
            display: flex; align-items: center; gap: 12px;
            background: #f8fafc; padding: 10px; border-radius: 14px;
            overflow-x: auto;
        }
        @media (max-width: 600px) {
            .split-unified-bar { flex-direction: column; align-items: flex-start; }
        }

        .payer-custom-button {
            display: flex; align-items: center; gap: 8px;
            background: white; border: 1px solid #cbd5e1; border-radius: 20px;
            padding: 6px 12px; height: 36px;
        }

        .split-members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            width: 100%;
        }

        footer {
            height: var(--footer-height);
            display: flex; justify-content: center; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .footer-pill {
            background: var(--primary-dark); color: white;
            padding: 8px 30px; border-radius: 50px; font-size: 0.75rem;
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-steps">
        <button class="step-btn active" id="btn-s1" onclick="goStep(1)">1. è—åœ–</button>
        <button class="step-btn" id="btn-s2" onclick="goStep(2)">2. ç´°ç¯€</button>
        <button class="step-btn" id="btn-s3" onclick="goStep(3)">3. æ˜Ÿåœ–</button>
        <button class="step-btn" id="btn-s4" onclick="goStep(4)">4. çµç®—</button>
    </div>
    <div class="nav-utils">
        <button class="util-btn" onclick="exportData()">ğŸ“¤ åŒ¯å‡º</button>
        <button class="util-btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥</button>
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
    </div>
</nav>

<div class="container" id="main-container">
    <!-- STEP 1 -->
    <div id="step-1" class="section active">
        <div class="card">
            <h2>â˜€ï¸ å†’éšªåº§æ¨™</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="font-weight:700; color:#64748b; font-size:0.8rem;">æ—…ç¨‹ä¸»é¡Œ</label>
                    <input type="text" id="main-dest" placeholder="æˆ‘çš„å¤¢å¹»ä¹‹æ—…">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-weight:700; color:#64748b; font-size:0.8rem;">å‡ºç™¼æ—¥æœŸ</label>
                        <input type="date" id="start-date">
                    </div>
                    <div>
                        <label style="font-weight:700; color:#64748b; font-size:0.8rem;">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="end-date">
                    </div>
                </div>
            </div>
            <button class="btn-main" style="margin-top: 25px;" onclick="calculateDates()">å‰å¾€è¦åŠƒç´°ç¯€ â”</button>
        </div>
    </div>

    <!-- STEP 2 -->
    <div id="step-2" class="section">
        <div class="card" style="border-left: 8px solid var(--primary-yellow); padding: 15px;">
            <h2 id="blueprint-title" style="margin:0; font-size:1.1rem;"></h2>
        </div>
        <div class="day-nav-wrapper">
            <button class="nav-arrow" id="prevDayBtn">â®</button>
            <div class="day-tabs-container" id="day-tabs-bar"></div>
            <button class="nav-arrow" id="nextDayBtn">â¯</button>
        </div>
        <div id="day-contents-container" style="flex:1; overflow-y:auto; padding-bottom: 20px;"></div>
        <button class="btn-main" style="background: var(--primary-dark); color: white;" onclick="goStep(3)">è§€æ¸¬å‹•æ…‹æ˜Ÿè±¡å„€ â”</button>
    </div>

    <!-- STEP 3 -->
    <div id="step-3" class="section" style="overflow: hidden;">
        <div id="constellation-container">
            <canvas id="starCanvas"></canvas>
            <div class="const-info">
                <h2 id="const-dest-name" style="text-shadow: 0 4px 10px rgba(0,0,0,0.8);"></h2>
                <p id="const-type-label" style="opacity: 0.95; font-size: 0.9rem; font-weight: 700; background: rgba(251, 206, 30, 0.2); padding: 5px 15px; border-radius: 50px; display: inline-block; color: var(--primary-yellow); border: 1px solid rgba(251, 206, 30, 0.4);"></p>
            </div>
        </div>
        <div class="card" style="display: grid; grid-template-columns: 1fr 1fr; text-align: center; padding: 15px;">
            <div><small style="color:#64748b; font-weight:700;">å†’éšªè·¨åº¦</small><br><strong id="final-days" style="font-size:1.2rem;">0</strong> <small>Days</small></div>
            <div><small style="color:#64748b; font-weight:700;">æ—…ç¨‹èƒ½é‡</small><br><strong id="final-budget" style="font-size:1.2rem; color:var(--teal-main);">$0</strong></div>
        </div>
    </div>

    <!-- STEP 4 -->
    <div id="step-4" class="section">
        <div class="split-layout">
            <div class="split-col-left">
                <div class="card" style="padding: 15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; font-size:0.9rem; color:var(--teal-main);">æ—…ä¼´</h3>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="new-member-name" placeholder="åå­—" style="width:70px; height:28px; font-size:0.8rem;">
                            <button class="add-member-btn" onclick="addMember()">+</button>
                        </div>
                    </div>
                    <div id="members-list" class="members-compact-container"></div>
                </div>
                <div class="settlement-card">
                    <h3 style="color:#14b8a6; font-size:1rem; margin:0 0 10px;">ğŸ“Š æ™ºæ…§çµç®—</h3>
                    <div id="settlement-report" style="flex:1; overflow-y:auto;"></div>
                </div>
            </div>
            <div class="split-col-right">
                <div class="day-nav-wrapper" id="split-day-nav-wrapper"></div>
                <div id="split-expenses-list"></div>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-pill">Daniel Shih <span>|</span> V5.1 Adaptive</div>
</footer>

<script>
    const state = {
        dest: "", startDate: null, endDate: null, daysCount: 0, dayData: [],
        activeDay: 1, activeSplitDay: 1,
        members: [{id: 'm1', name: 'æˆ‘'}], splitData: {}
    };

    let canvas, ctx, animationId;
    let stars = [], starDust = [];

    function goStep(n) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
        document.getElementById(`btn-s${n}`).classList.add('active');
        if (n === 3) setTimeout(initConstellation, 100);
        if (n === 4) initSettlement();
    }

    // --- STEP 1 & 2 Logic ---
    function calculateDates() {
        const dest = document.getElementById('main-dest').value;
        const s = document.getElementById('start-date').value, e = document.getElementById('end-date').value;
        if (!dest || !s || !e) return;
        state.dest = dest; state.startDate = s; state.endDate = e;
        state.daysCount = Math.ceil(Math.abs(new Date(e) - new Date(s)) / 86400000) + 1;
        state.dayData = []; buildUI(); goStep(2);
    }

    function buildUI() {
        const tabs = document.getElementById('day-tabs-bar'), cont = document.getElementById('day-contents-container');
        tabs.innerHTML = ''; cont.innerHTML = '';
        document.getElementById('blueprint-title').innerText = `${state.dest} (${state.daysCount}å¤©)`;
        const todayStr = new Date().toISOString().split('T')[0];
        let startObj = new Date(state.startDate);
        for (let i = 1; i <= state.daysCount; i++) {
            let cur = new Date(startObj); cur.setDate(startObj.getDate() + (i - 1));
            let dStr = cur.toISOString().split('T')[0], isT = dStr === todayStr;
            const tab = document.createElement('button');
            tab.className = `day-tab ${isT ? 'is-today' : ''}`; tab.id = `tab-d${i}`;
            tab.innerHTML = `Day ${i} <small>(${cur.getMonth()+1}/${cur.getDate()})</small>`;
            tab.onclick = () => switchDay(i); tabs.appendChild(tab);
            const dCont = document.createElement('div'); dCont.id = `content-d${i}`; dCont.className = 'day-content'; dCont.style.display = 'none';
            dCont.innerHTML = `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0; font-size:1rem;">ç¬¬ ${i} å¤©</h3><span id="day-total-${i}" style="color:var(--accent-orange); font-weight:800;">$0</span></div><div id="item-list-${i}"></div><button class="btn-add-item" onclick="addItem(${i})">ï¼‹ æ–°å¢è¡Œç¨‹èƒ½é‡é»</button></div>`;
            cont.appendChild(dCont);
            if(!state.dayData[i-1]) state.dayData[i-1] = { dayIndex: i, dateLabel: `${cur.getMonth()+1}/${cur.getDate()}`, items: [] };
            renderItems(i);
        }
        switchDay(1);
    }

    function switchDay(n) {
        state.activeDay = n;
        document.querySelectorAll('#day-tabs-bar .day-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.day-content').forEach(c => c.style.display = 'none');
        const t = document.getElementById(`tab-d${n}`); if(t) { t.classList.add('active'); t.scrollIntoView({ behavior:'smooth', inline:'center' }); }
        document.getElementById(`content-d${n}`).style.display = 'block';
        updateArrowStates();
    }

    function navigateDay(offset) { let t = state.activeDay + offset; if(t >= 1 && t <= state.daysCount) switchDay(t); }
    function updateArrowStates() { document.getElementById('prevDayBtn').disabled = state.activeDay <= 1; document.getElementById('nextDayBtn').disabled = state.activeDay >= state.daysCount; }
    function addItem(n) { state.dayData[n-1].items.push({ id: Date.now()+Math.random(), hour:'09', minute:'00', name:'', note:'', cat:'play', amt:0 }); renderItems(n); }
    function updateItem(n, id, f, v) { 
        const item = state.dayData[n-1].items.find(i => i.id === id); item[f] = f==='amt'? (parseFloat(v)||0) : v; 
        if(f==='hour'||f==='minute') { state.dayData[n-1].items.sort((a,b)=>`${a.hour}:${a.minute}`.localeCompare(`${b.hour}:${b.minute}`)); renderItems(n); } 
        else calculateDayTotal(n);
    }
    function renderItems(n) {
        const c = document.getElementById(`item-list-${n}`); c.innerHTML = '';
        state.dayData[n-1].items.forEach(item => {
            const r = document.createElement('div'); r.className = 'item-row';
            let hO = Array.from({length:24},(_,h)=>`<option value="${h.toString().padStart(2,'0')}" ${item.hour==h?'selected':''}>${h.toString().padStart(2,'0')}</option>`).join('');
            let cO = categories.map(cat=>`<option value="${cat.id}" ${item.cat===cat.id?'selected':''}>${cat.label}</option>`).join('');
            r.innerHTML = `
                <div class="time-select-group"><select onchange="updateItem(${n},${item.id},'hour',this.value)">${hO}</select><select onchange="updateItem(${n},${item.id},'minute',this.value)"><option value="00" ${item.minute==='00'?'selected':''}>00</option><option value="30" ${item.minute==='30'?'selected':''}>30</option></select></div>
                <input type="text" placeholder="åç¨±" value="${item.name}" oninput="updateItem(${n},${item.id},'name',this.value)">
                <select onchange="updateItem(${n},${item.id},'cat',this.value)">${cO}</select>
                <input type="number" placeholder="é‡‘é¡" value="${item.amt||''}" oninput="updateItem(${n},${item.id},'amt',this.value)">
                <div class="note-cell"><textarea placeholder="å‚™è¨»..." oninput="autoHeight(this); updateItem(${n},${item.id},'note',this.value)">${item.note}</textarea></div>
                <button class="btn-del" onclick="state.dayData[${n-1}].items=state.dayData[${n-1}].items.filter(i=>i.id!==${item.id}); renderItems(${n})" style="color:red; border:none; background:none;">âœ•</button>
            `;
            c.appendChild(r); autoHeight(r.querySelector('textarea'));
        });
        calculateDayTotal(n);
    }

    // --- STEP 4 Logic ---
    function initSettlement() { syncSplitDayNav(); renderMembers(); renderSplitList(); calculateSettlement(); }
    function syncSplitDayNav() {
        const w = document.getElementById('split-day-nav-wrapper');
        w.innerHTML = `<button class="nav-arrow" id="sp-prev">â®</button><div class="day-tabs-container" id="sp-tabs"></div><button class="nav-arrow" id="sp-next">â¯</button>`;
        const tabs = document.getElementById('sp-tabs');
        state.dayData.forEach(d => {
            const t = document.createElement('button'); t.className = `day-tab ${d.dayIndex===state.activeSplitDay?'active':''}`;
            t.innerHTML = `Day ${d.dayIndex}`; t.onclick = () => { state.activeSplitDay=d.dayIndex; initSettlement(); }; tabs.appendChild(t);
        });
        document.getElementById('sp-prev').onclick = () => { if(state.activeSplitDay>1){ state.activeSplitDay--; initSettlement(); }};
        document.getElementById('sp-next').onclick = () => { if(state.activeSplitDay<state.daysCount){ state.activeSplitDay++; initSettlement(); }};
        const activeT = tabs.children[state.activeSplitDay-1]; if(activeT) activeT.scrollIntoView({ behavior:'smooth', inline:'center' });
    }
    function addMember() { const n = document.getElementById('new-member-name').value.trim(); if(n){ state.members.push({id:'m'+Date.now(), name:n}); document.getElementById('new-member-name').value=''; initSettlement(); }}
    function renderMembers() { document.getElementById('members-list').innerHTML = state.members.map(m => `<div class="member-mini-pill">${m.name}<span onclick="state.members=state.members.filter(x=>x.id!=='${m.id}'); initSettlement()" style="margin-left:5px; color:red;">Ã—</span></div>`).join(''); }
    function renderSplitList() {
        const c = document.getElementById('split-expenses-list'); c.innerHTML = '';
        const items = state.dayData[state.activeSplitDay-1]?.items.filter(i => i.name && i.amt > 0) || [];
        if(!items.length) { c.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">æœ¬å€ç„¡å¸³ç›®</div>`; return; }
        items.forEach(item => {
            if(!state.splitData[item.id]) state.splitData[item.id] = { payerId: state.members[0].id, splits: {} };
            const split = state.splitData[item.id];
            state.members.forEach(m => { if(!split.splits[m.id]) split.splits[m.id] = { involved:true, amount:'' }; });
            let fixedSum = 0, dynamicCount = 0;
            Object.values(split.splits).forEach(s => { if(s.involved){ if(s.amount!=='') fixedSum += parseFloat(s.amount); else dynamicCount++; } });
            let share = dynamicCount > 0 ? (item.amt - fixedSum) / dynamicCount : 0;
            const membersHtml = state.members.map(m => {
                const s = split.splits[m.id];
                return `<div class="split-member-pill ${s.involved?'active':''}" onclick="s.involved=!s.involved; renderSplitList(); calculateSettlement()"><span>${m.name}</span>${s.involved?`<input type="number" class="mini-input" value="${s.amount}" placeholder="$${share.toFixed(0)}" onclick="event.stopPropagation()" onchange="state.splitData['${item.id}'].splits['${m.id}'].amount=this.value; renderSplitList(); calculateSettlement()">`:''}</div>`;
            }).join('');
            const pO = state.members.map(m => `<option value="${m.id}" ${split.payerId===m.id?'selected':''}>${m.name}</option>`).join('');
            const card = document.createElement('div'); card.className = 'split-item-card';
            card.innerHTML = `<div class="split-header-row"><div class="split-name">${item.name}</div><div class="split-amount">$${item.amt.toLocaleString()}</div></div><div class="split-unified-bar"><div class="payer-select-container"><div class="payer-custom-button"><div class="payer-avatar-badge">å¢Š</div><span class="payer-name-display">${state.members.find(m=>m.id===split.payerId)?.name}</span></div><select class="native-select-overlay" onchange="state.splitData['${item.id}'].payerId=this.value; renderSplitList(); calculateSettlement()">${pO}</select></div><div class="vertical-divider"></div><div class="split-members-grid">${membersHtml}</div></div>`;
            c.appendChild(card);
        });
    }
    function calculateSettlement() {
        const bals = {}; state.members.forEach(m => bals[m.id] = 0);
        state.dayData.forEach(d => d.items.forEach(i => {
            if(!i.name || i.amt <= 0) return;
            const split = state.splitData[i.id]; if(!split) return;
            bals[split.payerId] += i.amt;
            let fixed = 0, dynCount = 0;
            Object.entries(split.splits).forEach(([mid, s]) => { if(s.involved){ if(s.amount!=='') { let val = parseFloat(s.amount); fixed += val; bals[mid] -= val; } else dynCount++; } });
            let share = dynCount > 0 ? (i.amt - fixed) / dynCount : 0;
            Object.entries(split.splits).forEach(([mid, s]) => { if(s.involved && s.amount==='') bals[mid] -= share; });
        }));
        const report = document.getElementById('settlement-report');
        const balArr = state.members.map(m => ({ ...m, bal: bals[m.id] })).sort((a,b) => b.bal - a.bal);
        const banker = balArr[0];
        if(!banker || Math.abs(banker.bal) < 1) { report.innerHTML = `<p style="text-align:center; opacity:0.5;">ç›®å‰å¸³ç›®å¹³è¡¡</p>`; return; }
        let html = `<div style="padding:10px; background:rgba(255,255,255,0.1); border-radius:12px; margin-bottom:15px;">ğŸ‘‘ Banker: <span style="color:var(--primary-yellow);">${banker.name}</span></div>`;
        balArr.filter(m => m.bal < -0.5).forEach(m => html += `<div class="settlement-step to-banker"><span>${m.name}</span> <span>â” ${banker.name}</span> <strong>$${Math.abs(m.bal).toFixed(0)}</strong></div>`);
        balArr.filter(m => m.bal > 0.5 && m.id !== banker.id).forEach(m => html += `<div class="settlement-step"><span>${banker.name}</span> <span>â” ${m.name}</span> <strong>$${m.bal.toFixed(0)}</strong></div>`);
        report.innerHTML = html;
    }

    // --- STEP 3 Star Map (æ‰‹æ©Ÿå…¨å±å„ªåŒ–) ---
    function initConstellation() {
        canvas = document.getElementById('starCanvas'); ctx = canvas.getContext('2d');
        const container = document.getElementById('constellation-container');
        canvas.width = container.offsetWidth; canvas.height = container.offsetHeight;
        const cx = canvas.width / 2, cy = canvas.height / 2;
        const isMobile = window.innerWidth < 768;

        stars = Array.from({length: isMobile ? 60 : 46}, () => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, s: 0.8 + Math.random() * 1.5, o: Math.random(), sp: 0.005 + Math.random() * 0.015 }));
        starDust = Array.from({length: isMobile ? 80 : 58}, () => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, s: Math.random() * 0.5, o: Math.random(), spY: 0.002 + Math.random() * 0.008 }));
        
        const summary = { eat: 0, stay: 0, play: 0, move: 0, buy: 0, event: 0 };
        let totalAll = 0;
        state.dayData.forEach(d => d.items.forEach(i => { if(summary[i.cat] !== undefined) { summary[i.cat] += i.amt; totalAll += i.amt; } }));

        document.getElementById('final-days').innerText = state.daysCount;
        document.getElementById('final-budget').innerText = `$${totalAll.toLocaleString()}`;
        document.getElementById('const-dest-name').innerText = state.dest || "æ—…ç¨‹";
        document.getElementById('const-type-label').innerText = generateSoulTitle(summary);

        const sorted = Object.keys(summary).sort((a,b)=>summary[b]-summary[a]);
        const pColor = categories.find(c=>c.id===sorted[0])?.color || '#fbbf24';
        
        // æ‰‹æ©Ÿç‰ˆä½¿ç”¨æ›´å¤§çš„å®‰å…¨é‚Šè·èˆ‡åŠå¾‘
        const safeMargin = isMobile ? 60 : 120; 
        const maxRadius = Math.min(canvas.width, canvas.height) / 2 - safeMargin;
        const baseDistFactor = maxRadius / (Math.min(canvas.width, canvas.height) / 2);

        const baseAngles = [-Math.PI/2, -Math.PI/6, Math.PI/6, Math.PI/2, 5*Math.PI/6, 7*Math.PI/6];
        const rawNodeData = [ {id:'stay', label:'ä½å®¿', val:summary.stay, color:'#f472b6'}, {id:'eat', label:'ç¾é£Ÿ', val:summary.eat, color:'#fbbf24'}, {id:'play', label:'æ¢è¨ª', val:summary.play, color:'#38bdf8'}, {id:'buy', label:'è³¼ç‰©', val:summary.buy, color:'#4ade80'}, {id:'move', label:'äº¤é€š', val:summary.move, color:'#a78bfa'}, {id:'event', label:'é«”é©—', val:summary.event, color:'#f97316'} ];
        const nodeData = rawNodeData.map((n, i) => {
            const r = totalAll > 0 ? (n.val / totalAll) : 0.15;
            // æ‰‹æ©Ÿç‰ˆå¢åŠ éš¨æ©Ÿå¹…åº¦
            const jitterAngle = (Math.random() - 0.5) * (isMobile ? 1.5 : 1.1); 
            const jitterDist = (isMobile ? 0.4 : 0.65) + Math.random() * (isMobile ? 0.9 : 0.65); 
            return { ...n, angle: baseAngles[i] + jitterAngle, dist: baseDistFactor * jitterDist * (0.8 + r * 0.4) };
        });

        function drawSoftStar(x, y, size, color, opacity) {
            ctx.save(); ctx.translate(x, y);
            const g1 = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 3); g1.addColorStop(0, color + Math.floor(opacity * 60).toString(16).padStart(2, '0')); g1.addColorStop(1, 'transparent'); ctx.fillStyle = g1; ctx.beginPath(); ctx.arc(0, 0, size * 3, 0, Math.PI * 2); ctx.fill();
            const g2 = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 1.5); g2.addColorStop(0, color + Math.floor(opacity * 180).toString(16).padStart(2, '0')); g2.addColorStop(0.5, color + "00"); g2.addColorStop(1, 'transparent'); ctx.fillStyle = g2; ctx.beginPath(); ctx.arc(0, 0, size * 1.5, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = size / 2; ctx.shadowColor = "#fff"; ctx.fillStyle = "rgba(255, 255, 255, " + (opacity * 0.9) + ")"; ctx.beginPath(); ctx.arc(0, 0, 3 + size/15, 0, Math.PI * 2); ctx.fill(); ctx.restore();
        }

        let tick = 0;
        function animate() {
            tick += 0.0040; ctx.clearRect(0,0,canvas.width,canvas.height);
            starDust.forEach(d => { d.y += d.spY; if(d.y > canvas.height) d.y = 0; ctx.fillStyle = `rgba(255,255,255,${0.02 + Math.sin(tick*1.5 + d.o)*0.02})`; ctx.beginPath(); ctx.arc(d.x, d.y, d.s, 0, Math.PI*2); ctx.fill(); });
            stars.forEach(s => { s.y += s.sp; if(s.y > canvas.height) s.y = 0; ctx.fillStyle=`rgba(255,255,255,${0.05 + Math.sin(tick*0.8 + s.o)*0.08})`; ctx.beginPath(); ctx.arc(s.x,s.y,s.s,0,Math.PI*2); ctx.fill(); });
            ctx.save(); ctx.beginPath();
            nodeData.forEach((n, i) => { const dynamicDist = n.dist + Math.sin(tick*0.3 + i)*0.0001; const px = cx + Math.cos(n.angle) * dynamicDist * (canvas.width/2); const py = cy + Math.sin(n.angle) * dynamicDist * (canvas.height/2); if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py); });
            ctx.closePath(); const nebulaGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxRadius * 1.8); nebulaGrad.addColorStop(0, pColor + '05'); nebulaGrad.addColorStop(1, 'transparent'); ctx.fillStyle = nebulaGrad; ctx.globalCompositeOperation = "screen"; ctx.fill(); ctx.restore();
            nodeData.forEach((n, i) => {
                const r = totalAll > 0 ? (n.val / totalAll) : 0.15;
                const size = (isMobile ? 25 : 15) + r * 50 + Math.sin(tick*1.5 + n.angle)*0.4; 
                const px = cx + Math.cos(n.angle) * n.dist * (canvas.width/2);
                const py = cy + Math.sin(n.angle) * n.dist * (canvas.height/2);
                drawSoftStar(px, py, size, n.color, 0.3 + r * 0.7);
                ctx.fillStyle="rgba(255,255,255,0.75)"; ctx.font=`700 ${isMobile?14:13}px Quicksand, Noto Sans TC`; ctx.textAlign="center"; 
                ctx.fillText(n.label, px, py - (size * 0.8) - 15);
            });
            animationId = requestAnimationFrame(animate);
        }
        animate();
    }

    function generateSoulTitle(s) {
        const sorted = Object.keys(s).sort((a, b) => s[b] - s[a]);
        const main = sorted[0], sub = sorted[1];
        if (Object.values(s).reduce((a, b) => a + b, 0) === 0) return "ç©ºéˆæ—…è€…";
        const pool = {
            eat: { play: ["è–é¤æ¢éšªå®¶"], stay: ["æ„Ÿå®˜å›ç‹"], buy: ["æµå‹•ç››å®´æ”¶è—å®¶"], move: ["ç–¾èµ°å‘³è•¾çµæ‰‹"], event: ["å¤šå·´èƒºç¥­å¸"] },
            play: { eat: ["è’é‡è–å¾’"], stay: ["éœä¿®æ¢éšªè€…"], buy: ["å¥‡è§€æ”¶å‰²è€…"], move: ["æ°¸æ†è¿½å…‰è€…"], event: ["éˆé­‚æ…¶å…¸é–‹æ‹“è€…"] },
            stay: { eat: ["å®®å»·å¤¢éŠè€…"], play: ["èˆ’é©å€å†’éšªå®¶"], buy: ["å±…æ‰€éš±å£«"], move: ["ç§»å‹•å®®æ®¿é ˜ä¸»"], event: ["å¤¢å¢ƒåŠ‡å ´åƒèˆ‡è€…"] },
            buy: { eat: ["æ„Ÿå®˜éŠ€è¡Œå®¶"], play: ["æˆ°åˆ©å“å¤§å¸«"], stay: ["ç‰©æ¬Šç¥­å¸"], move: ["æ™‚å°šéŠä¿ "], event: ["æƒ…æ„Ÿè³‡ç”¢ç®¡ç†äºº"] },
            move: { eat: ["å…¬è·¯ç±³å…¶æ—"], play: ["åº§æ¨™é–ƒé›»æ‰‹"], stay: ["å¼•æ“ç¡çœ è€…"], buy: ["è·¨æ™‚å€æ¬é‹å·¥"], event: ["ç¬é–“æ”å½±å¸«"] },
            event: { eat: ["èˆŒå°–æ…¶å…¸"], play: ["æ´»å‹•æ”»ç•¥çµ„"], stay: ["æ²‰æµ¸å¼å“²äºº"], buy: ["å›æ†¶æ”¶è—å®¶"], move: ["ç†±è¡€è¶•å ´äºº"] }
        };
        return pool[main]?.[sub]?.[0] || "è‡ªç”±æ˜Ÿç³»æ—…äºº";
    }

    function exportData() { const b = new Blob([JSON.stringify(state)], {type: "application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `DreamVoyage_V5.1.json`; a.click(); }
    function importData(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev) => { Object.assign(state, JSON.parse(ev.target.result)); document.getElementById('main-dest').value = state.dest; document.getElementById('start-date').value = state.startDate; document.getElementById('end-date').value = state.endDate; buildUI(); goStep(2); }; r.readAsText(f); }
    window.addEventListener('resize', () => { if(document.getElementById('step-3').classList.contains('active')) initConstellation(); });
</script>

</body>
</html>
